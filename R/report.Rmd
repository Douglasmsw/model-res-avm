---
title: "Model Summary"
author: "Cook County Assessor's Office"
date: "`r format(Sys.time(), '%d %B, %Y @ %r')`"
output: html_document
---

```{r setup, include=FALSE}
library(arrow)
library(dplyr)
library(DT)
library(ccao)
library(assessr)
source("cknn_funs.R")
```

## Overall Results

```{r, message=FALSE}
# Load the test set results from file
test <- read_parquet("../data/test_set.parquet")

# Create a summary of test set results by township
test_summary <- test %>%
  select(meta_town_code, meta_sale_price, ends_with("sale_price")) %>%
  mutate(
    town_name = town_convert(meta_town_code),
    outlier = is_outlier(stack_sale_price / meta_sale_price)
  ) %>%
  rename_with(
    ~ gsub("_sale_price", "", .x),
    meta_sale_price:stack_sale_price
  ) %>%
  group_by(town_name) %>%
  summarize(
    count = n(),
    across(lm:stack, ~ cod(.x / meta), .names = "{.col}_cod"),
    across(stack, ~ cod((.x / meta)[!outlier]), .names = "{.col}_cod_trim")
  ) %>%
  arrange(stack_cod)

test_summary

```

## Township Map

```{r, message = FALSE, out.width='100%'}
ccao::town_shp %>%
  left_join(test_summary, by = c("township_name" = "town_name")) %>%
  ggplot() +
  geom_sf(aes(fill = stack_cod_trim)) +
  scale_fill_distiller(name = "COD", palette = "Spectral") +
  labs(title = "COD by Township for Trimmed Stacked Model") +
  theme_void()
```

## CkNN Grid Search

```{r, message = FALSE, out.width='100%'}
# Load and plot CkNN grid search results
cknn_results <- read_parquet("../data/models/cknn_results.parquet")
cknn_grid_plot(cknn_results, m, k, l, cod) 
```

## Lasso Grid Search

```{r, message = FALSE, out.width='100%'}
# Load and plot lasso grid search results
lasso_results <- read_parquet("../data/models/lasso_results.parquet")
lasso_results %>%
  ggplot(aes(penalty, mean, color = .metric)) +
    geom_errorbar(
      aes(ymin = mean - std_err, ymax = mean + std_err),
      alpha = 0.5
    ) +
    geom_line(size = 1.5) +
    facet_wrap(vars(.metric), scales = "free", nrow = 2) +
    scale_x_log10() +
    guides(color = guide_legend(title = "Metric")) +
    theme(legend.position = "none") +
    theme_minimal()
```


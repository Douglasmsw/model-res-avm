type,name,stage_number,stage_name,s3_bucket,path_dvc,path_local,path_s3,athena_table,observation_unit,primary_key,run_on_type_automated,run_on_type_experiment,run_on_type_candidate,run_on_type_final,notes
input,training,0,ingest,ccao-data-dvc-us-east-1,input/training_data.parquet.dvc,input/training_data.parquet,,,pin,"year, meta_pin",FALSE,FALSE,FALSE,TRUE,"Excludes any multi-card PINs, therefore unit of observation is PIN"
input,assessment,0,ingest,ccao-data-dvc-us-east-1,input/assessment_data.parquet.dvc,input/assessment_data.parquet,,,improvement,"year, meta_pin, meta_card_num",FALSE,FALSE,FALSE,TRUE,Includes all improvements that need valuation
output,metadata,1,setup,ccao-model-results-us-east-1,,output/metadata/model_metadata.parquet,metadata/year={year}/{run_id}.parquet,metadata,model run,"year, run_id",TRUE,TRUE,TRUE,TRUE,Information about each run
output,parameter_search,2,train,ccao-model-results-us-east-1,,output/parameter_search/model_parameter_search.parquet,parameter_search/year={year}/{run_id}.parquet,parameter_search,model cv fold,"year, run_id, configuration, fold_id",FALSE,TRUE,TRUE,TRUE,Each row is the result from one fold assessment from one iteration
output,parameter_raw,2,train,ccao-model-results-us-east-1,,output/parameter_search/model_parameter_search.parquet,parameter_raw/year={year}/{run_id}.parquet,,model cv fold,"year, run_id, configuration, fold_id",TRUE,TRUE,TRUE,TRUE,Raw output from CV/tuning. Not useful in Athena but needed to make models reproducible
output,parameter_final,2,train,ccao-model-results-us-east-1,,output/parameter_final/model_parameter_final.parquet,parameter_final/year={year}/{run_id}.parquet,parameter_final,model run,"year, run_id",TRUE,TRUE,TRUE,TRUE,"Best hyperparameters for each run, as chosen by tune::select_best()"
output,parameter_range,2,train,ccao-model-results-us-east-1,,output/parameter_range/model_parameter_range.parquet,parameter_range/year={year}/{run_id}.parquet,parameter_range,parameter,"year, run_id, parameter_name",FALSE,TRUE,TRUE,TRUE,CV search range per parameter per run
intermediate,test,2,train,,,output/intermediate/model_test.parquet,,,pin,"year, meta_pin",TRUE,TRUE,TRUE,TRUE,Input test data with model prediction attached. Saved temporarily for use in evaluate stage
output,workflow_fit,2,train,ccao-model-results-us-east-1,,output/workflow/fit/model_workflow_fit.zip,workflow/fit/year={year}/{run_id}.zip,,model run,,TRUE,TRUE,TRUE,TRUE,Trained model object saved for future use
output,workflow_recipe,2,train,ccao-model-results-us-east-1,,output/workflow/recipe/model_workflow_recipe.rds,workflow/recipe/year={year}/{run_id}.rds,,model run,,TRUE,TRUE,TRUE,TRUE,Trained recipe object. Can be used to prepare new data in the same way as the original model training
intermediate,assessment,3,assess,,,output/intermediate/model_assessment.parquet,,,pin,"year, meta_pin",FALSE,TRUE,TRUE,TRUE,Assessment results AGGREGATED to the PIN level. Model predictions are added together in the case of multi-card PINs. This is the data used for performance evaluation by the evaluate stage
output,assessment,3,assess,ccao-model-results-us-east-1,,output/assessment/model_assessment.parquet,assessment/,assessment,improvement,"year, run_id, township_code, meta_pin, meta_card_num",FALSE,FALSE,TRUE,TRUE,Assessment results at the improvement level. Multi-card PINs will have more than one row. NOTE: Each run adds new partitions to S3 which must be added via a Glue crawler
output,performance_test,4,evaluate,ccao-model-results-us-east-1,,output/performance/model_performance_test.parquet,performance/year={year}/stage=test/{run_id}.parquet,performance,geography [by class],"year, run_id, stage, geography_type, geography_id, by_class, class",TRUE,TRUE,TRUE,TRUE,Peformance metrics (optionally) broken out by class for different levels of geography
output,performance_assessment,4,evaluate,ccao-model-results-us-east-1,,output/performance/model_performance_assessment.parquet,performance/year={year}/stage=assessment/{run_id}.parquet,performance,geography [by class],"year, run_id, stage, geography_type, geography_id, by_class, class",FALSE,TRUE,TRUE,TRUE,Peformance metrics (optionally) broken out by class for different levels of geography
output,performance_quantile_test,4,evaluate,ccao-model-results-us-east-1,,output/performance_quantile/model_performance_quantile_test.parquet,performance_quantile/year={year}/stage=test/{run_id}.parquet,performance_quantile,geography [by class] by quantile,"year, run_id, stage, geography_type, geography_id, by_class, class, quantile",TRUE,TRUE,TRUE,TRUE,Performance metrics by quantile within class and geography
output,performance_quantile_assessment,4,evaluate,ccao-model-results-us-east-1,,output/performance_quantile/model_performance_quantile_assessment.parquet,performance_quantile/year={year}/stage=assessment/{run_id}.parquet,performance_quantile,geography [by class] by quantile,"year, run_id, stage, geography_type, geography_id, by_class, class, quantile",FALSE,TRUE,TRUE,TRUE,Performance metrics by quantile within class and geography
output,shap,5,interpret,ccao-model-results-us-east-1,,output/shap/model_shap.parquet,shap/,shap,improvement,"year, run_id, township_code, meta_pin, meta_card_num",FALSE,FALSE,TRUE,TRUE,SHAP values for each feature of each improvement in the assessment data. NOTE: Each run adds new partitions to S3 which must be added via a Glue crawler
intermediate,timing,,all,,,output/intermediate/model_timing.parquet,,,model stage,"year, msg",TRUE,TRUE,TRUE,TRUE,Intermediate collection of timings for each stage. Converted into a one-row data frame in the finalize stage
output,timing,,all,ccao-model-results-us-east-1,,output/timing/model_timing.parquet,timing/year={year}/{run_id}.parquet,timing,model run,"year, run_id",TRUE,TRUE,TRUE,TRUE,"Timings for whole run. Each row represents one run, while columns represent the stages"

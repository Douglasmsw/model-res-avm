schema: '2.0'
stages:
  ingest:
    cmd: Rscript pipeline/00-ingest.R
    params:
      params.yaml:
        assessment:
          year: '2022'
          date: '2022-01-01'
          triad: north
          group: residential
          data_year: '2021'
        input:
          min_sale_year: '2015'
          max_sale_year: '2021'
          complex:
            match_exact:
            - meta_township_code
            - meta_class
            - char_bsmt
            - char_gar1_size
            - char_attic_fnsh
            - char_beds
            match_fuzzy:
              rooms: 1
              bldg_sf: 25
              yrblt: 4
              dist_ft: 250
    outs:
    - path: input/assessment_data.parquet
      md5: 5ccfb2bb069c63b329df3d979e55678e
      size: 283557153
      isexec: true
    - path: input/complex_id_data.parquet
      md5: 716a49453bcbbb66c39d162f751bc6d4
      size: 719229
      isexec: true
    - path: input/land_nbhd_rate_data.parquet
      md5: d4d45190b5b8b1491717429da75dc904
      size: 3612
      isexec: true
    - path: input/land_site_rate_data.parquet
      md5: e7b3de0ce18a01834c51089072159379
      size: 197036
      isexec: true
    - path: input/training_data.parquet
      md5: 1aa59a250063ab447ed9e4c166445364
      size: 100463102
      isexec: true
  train:
    cmd: Rscript pipeline/01-train.R
    deps:
    - path: input/training_data.parquet
      md5: 1aa59a250063ab447ed9e4c166445364
      size: 100463102
    params:
      params.yaml:
        cv:
          num_folds: 3
          initial_set: 3
          max_iterations: 6
          no_improve: 3
          split_prop: 0.9
          best_metric: rmse
        model.engine: lightgbm
        model.hyperparameter.range:
          stop_iter:
          - 5
          - 30
          num_leaves:
          - 500
          - 5000
          add_to_linked_depth:
          - 1
          - 3
          max_depth:
          - 4
          - 16
          feature_fraction:
          - 0.3
          - 1.0
          min_gain_to_split:
          - -4.0
          - 1.5
          min_data_in_leaf:
          - 2
          - 200
          max_cat_threshold:
          - 20
          - 250
          min_data_per_group:
          - 20
          - 250
          cat_smooth:
          - 10.0
          - 100.0
          cat_l2:
          - -3
          - 2
          lambda_l1:
          - -3
          - 2
          lambda_l2:
          - -3
          - 2
        model.objective: rmse
        model.parameter:
          num_iterations: 10
          learning_rate: 0.1
          validation_prop: 0.1
          validation_metric: rmse
          link_max_depth: true
        model.predictor:
          all:
          - meta_township_code
          - meta_nbhd_code
          - meta_tieback_proration_rate
          - char_yrblt
          - char_air
          - char_apts
          - char_attic_fnsh
          - char_attic_type
          - char_beds
          - char_bldg_sf
          - char_bsmt
          - char_bsmt_fin
          - char_ext_wall
          - char_fbath
          - char_frpl
          - char_gar1_area
          - char_gar1_att
          - char_gar1_cnst
          - char_gar1_size
          - char_hbath
          - char_land_sf
          - char_heat
          - char_ncu
          - char_porch
          - char_roof_cnst
          - char_rooms
          - char_tp_dsgn
          - char_tp_plan
          - char_type_resd
          - char_use
          - loc_cook_municipality_name
          - loc_env_flood_fema_sfha
          - loc_env_flood_fs_factor
          - loc_env_flood_fs_risk_direction
          - loc_env_ohare_noise_contour_no_buffer_bool
          - loc_school_elementary_district_geoid
          - loc_school_secondary_district_geoid
          - loc_school_unified_district_geoid
          - loc_tax_special_service_area_num
          - loc_access_cmap_walk_nta_score
          - loc_access_cmap_walk_total_score
          - loc_misc_subdivision_id
          - loc_misc_unincorporated_area_bool
          - prox_num_pin_in_half_mile
          - prox_num_bus_stop_in_half_mile
          - prox_num_foreclosure_per_1000_pin_past_5_years
          - prox_num_school_in_half_mile
          - prox_num_school_with_rating_in_half_mile
          - prox_avg_school_rating_in_half_mile
          - prox_nearest_bike_trail_dist_ft
          - prox_nearest_cemetery_dist_ft
          - prox_nearest_cta_route_dist_ft
          - prox_nearest_cta_stop_dist_ft
          - prox_nearest_hospital_dist_ft
          - prox_lake_michigan_dist_ft
          - prox_nearest_major_road_dist_ft
          - prox_nearest_metra_route_dist_ft
          - prox_nearest_metra_stop_dist_ft
          - prox_nearest_park_dist_ft
          - prox_nearest_railroad_dist_ft
          - prox_nearest_water_dist_ft
          - acs5_percent_age_children
          - acs5_percent_age_senior
          - acs5_median_age_total
          - acs5_percent_mobility_no_move
          - acs5_percent_mobility_moved_from_other_state
          - acs5_percent_household_family_married
          - acs5_percent_household_nonfamily_alone
          - acs5_percent_education_high_school
          - acs5_percent_education_bachelor
          - acs5_percent_education_graduate
          - acs5_percent_income_below_poverty_level
          - acs5_median_income_household_past_year
          - acs5_median_income_per_capita_past_year
          - acs5_percent_income_household_received_snap_past_year
          - acs5_percent_employment_unemployed
          - acs5_median_household_total_occupied_year_built
          - acs5_median_household_renter_occupied_gross_rent
          - acs5_median_household_owner_occupied_value
          - acs5_percent_household_owner_occupied
          - acs5_percent_household_total_occupied_w_sel_cond
          - acs5_percent_mobility_moved_in_county
          - other_ihs_avg_year_index
          - other_tax_bill_amount_total
          - other_tax_bill_rate
          - other_school_district_elementary_avg_rating
          - other_school_district_secondary_avg_rating
          - time_sale_year
          - time_sale_week
          - time_sale_quarter_of_year
          - time_sale_week_of_year
          - time_sale_during_school_year
          - time_sale_during_holidays
          - ind_land_gte_95_percentile
          - ind_bldg_gte_95_percentile
          - ind_land_bldg_ratio_gte_10
          - ind_pin_is_multicard
          categorical:
          - meta_township_code
          - meta_nbhd_code
          - char_air
          - char_apts
          - char_attic_fnsh
          - char_attic_type
          - char_bsmt
          - char_bsmt_fin
          - char_ext_wall
          - char_gar1_area
          - char_gar1_att
          - char_gar1_cnst
          - char_gar1_size
          - char_heat
          - char_porch
          - char_roof_cnst
          - char_tp_dsgn
          - char_tp_plan
          - char_type_resd
          - char_use
          - loc_cook_municipality_name
          - loc_school_elementary_district_geoid
          - loc_school_secondary_district_geoid
          - loc_school_unified_district_geoid
          - loc_tax_special_service_area_num
          - loc_misc_subdivision_id
          - time_sale_quarter_of_year
          id:
          - meta_year
          - meta_pin
          - meta_class
          - meta_card_num
          - meta_sale_document_num
        model.seed: 20220117
        model.verbose: -1
        toggle.cv_enable: true
    outs:
    - path: output/parameter_final/model_parameter_final.parquet
      md5: caa3f3ed4fb36bca85d6b1c4cb5e2aee
      size: 7823
    - path: output/parameter_range/model_parameter_range.parquet
      md5: 0023a7925b14bbf7ef2887c3b49774e4
      size: 1964
    - path: output/parameter_search/model_parameter_search.parquet
      md5: 0cf613f1b862ae0e68e4780c8732c54f
      size: 196962
    - path: output/workflow/fit/model_workflow_fit.zip
      md5: 3cc38f62f8486deb3c0201861b38f4c5
      size: 572416
    - path: output/workflow/recipe/model_workflow_recipe.rds
      md5: 0aa52b7eef79c787c1b3cccf4b6c5a5f
      size: 1929011
